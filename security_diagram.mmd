graph TD
    subgraph "Capa de Usuario"
        PASS[Contraseña Usuario]
        SALT[Salt Único]
    end
    
    subgraph "Derivación de Claves"
        PBKDF2[PBKDF2 100k iter]
        MASTER[Clave Maestra]
        HKDF[HKDF Derivación]
    end
    
    subgraph "Claves Específicas"
        HEALTH[Clave Registros Salud]
        AUTH[Clave Autenticación]
        BACKUP[Clave Backup]
        CHAT[Clave Chat]
    end
    
    subgraph "Operaciones de Cifrado"
        AES[AES-GCM-256]
        IV[IV Aleatorio]
        TAG[Tag Autenticación]
    end
    
    subgraph "Almacenamiento"
        IDB_ENC[(IndexedDB Cifrado)]
        GIST_ENC[(Gist Cifrado)]
        LOCAL[Almacenamiento Local]
    end
    
    subgraph "Auditoría"
        AUDIT[Log Auditoría]
        HASH[Hash Integridad]
        TIMESTAMP[Timestamp]
    end
    
    PASS --> PBKDF2
    SALT --> PBKDF2
    PBKDF2 --> MASTER
    MASTER --> HKDF
    
    HKDF --> HEALTH
    HKDF --> AUTH
    HKDF --> BACKUP
    HKDF --> CHAT
    
    HEALTH --> AES
    IV --> AES
    AES --> TAG
    
    AES --> IDB_ENC
    BACKUP --> GIST_ENC
    AUTH --> LOCAL
    
    AES --> AUDIT
    AUDIT --> HASH
    AUDIT --> TIMESTAMP
    
    classDef user fill:#ffebee
    classDef crypto fill:#e3f2fd
    classDef keys fill:#f3e5f5
    classDef storage fill:#e8f5e8
    classDef audit fill:#fff3e0
    
    class PASS,SALT user
    class PBKDF2,MASTER,HKDF,AES,IV,TAG crypto
    class HEALTH,AUTH,BACKUP,CHAT keys
    class IDB_ENC,GIST_ENC,LOCAL storage
    class AUDIT,HASH,TIMESTAMP audit

